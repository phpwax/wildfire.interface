<?
$partial_paths = array(
                      APP_DIR."view/".$controller."/%s%.html",
                      APP_DIR."view/shared/%s%.html"
                      );
foreach((array)Autoloader::view_paths("plugin") as $path){
  $partial_paths[] = $path.strtoupper($use_plugin).Inflections::camelize(str_replace("/","_",$controller),true)."Controller/%s%.html";
  $partial_paths[] = $path."shared/%s%.html";
}

$grouping = array();
$mods = CMSApplication::get_modules();
foreach($form as $k=>$ele) if((($g = $ele->group) || ($g = "details")) && $ele->editable && ($g = strtolower($g)) && ($current_user->allowed($module_name, "tab-".$g)) ) $grouping[$g][$k] = $ele;
WaxEvent::run('cms.edit.grouping', $grouping);
if(($show_group = Request::param('group')) && isset($grouping[$show_group])) $grouping = array($show_group => $grouping[$show_group]);
$counter = 0;
$primary_tabs = $secondary_tabs = false;
foreach($grouping as $g=>$info){
  if(in_array($g, CMSApplication::$form_primary_tabs)) $secondary_tabs[$g] = $info;
  else $primary_tabs[$g] = $info;
}
?>
<?=partial("_form_start", $this)?>


  <div class='edit_form_block_container clearfix<?if($secondary_tabs):?> with_meta_tabs<?endif?>'>
    <?if($secondary_tabs):?>
      <div class='meta_tabs accordion clearfix'>
        <?foreach($secondary_tabs as $name=>$fields):?>
          <?$tabhash = Inflections::to_url($name);?>
          <h3 class='accordion_header meta-tab-title'><?=$name?></h3>
          <div class="meta-tab clearfix">
            <?if(!$partial = CMSBaseComponent::form_group_partial_check($name)) $partial = "_default_form_group";?>
            <?=partial($patial, array('tabhash'=>$tabhash, 'model'=>$model, 'controller'=>$controller, 'fields'=>$fields, 'partial_paths'=>$partial_paths, 'scaffold_columns'=>$scaffold_columns, 'current_user'=>$current_user, 'operation_actions'=>$operation_actions, 'file_system_base'=>$file_system_base));?>
          </div>
        <?endforeach?>
      </div>
    <?endif?>





  <?if(count($grouping)):?>
    <?=partial("_intro", array('model'=>$model, 'controller'=>$controller, 'autosave'=>$autosave))?>

    <ul class='tabs clearfix'>
      <?$k=0;?>
      <?foreach($grouping as $name=>$info):?>
        <?$tabhash = Inflections::to_url($name); $tabid = "tab-".$tabhash;?>
        <li id="<?=$tabid?>" class='tab-<?=$k?>'><a href="#<?=$tabhash?>"><?=ucwords($name)?></a></li>
        <?$k++;?>
      <?endforeach?>
    </ul>

    <?foreach($grouping as $name=>$fields):?>
      <?$tabhash = Inflections::to_url($name);?>
      <fieldset class='tab-contents clearfix <?=$tabhash?>' id="<?=$tabhash?>" >
      <?if(!$readable = CMSBaseComponent::form_group_partial_check($name)) $readable = "_default_form_group";?>
      <?=partial($readable, array('tabhash'=>$tabhash, 'model'=>$model, 'controller'=>$controller, 'fields'=>$fields, 'partial_paths'=>$partial_paths, 'scaffold_columns'=>$scaffold_columns, 'current_user'=>$current_user, 'operation_actions'=>$operation_actions, 'file_system_base'=>$file_system_base))?>

      </fieldset>

    <?endforeach?>
    <fieldset class='submit'>
    <?=partial("_submit", array('model'=>$model, 'controller'=>$controller, 'model_class'=>$model_class, 'autosave'=>$autosave))?>
    </fieldset>
  <?endif?>
</form>


<?=partial("_dialog_links", array('controller'=>$controller, "file_system_model"=>$file_system_model))?>
<?=partial("_dialog_source_code", array('controller'=>$controller))?>
<?=partial("_dialog_images", $this)?>
<?=partial("_dialog_tables", array('controller'=>$controller))?>
<?=partial("_dialog_templates", array('controller'=>$controller))?>
